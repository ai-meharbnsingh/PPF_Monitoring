###############################################################################
# mosquitto.conf
# Eclipse Mosquitto 2 Configuration — PPF Workshop Monitoring System
#
# MQTT Topics (must match firmware config.h and backend constants.py):
#   Sensor data:   workshop/{id}/pit/{id}/sensors
#   Device status: workshop/{id}/device/{device_id}/status
#   Commands:      workshop/{id}/device/{device_id}/command
#
# Author: PPF Monitoring Team
# Created: 2026-02-22
###############################################################################

# ─── Persistence ──────────────────────────────────────────────────────────────
persistence true
persistence_location /mosquitto/data/

# ─── Logging ──────────────────────────────────────────────────────────────────
log_dest file /mosquitto/log/mosquitto.log
log_dest stdout
log_type error
log_type warning
log_type notice
log_type information
log_timestamp true
log_timestamp_format %Y-%m-%dT%H:%M:%S

# ─── Listener: plain MQTT (1883) ─────────────────────────────────────────────
listener 1883
protocol mqtt

# ─── Listener: MQTT over WebSocket (9001) ────────────────────────────────────
# Used for browser-based dashboard clients (if any)
listener 9001
protocol websockets

# ─── Authentication ───────────────────────────────────────────────────────────
# Password file — generate with: mosquitto_passwd -c /mosquitto/config/passwd <username>
# Users:
#   ppf_backend   — FastAPI backend subscriber (high privilege)
#   mqtt_user     — Generic MQTT user for devices (matches firmware config.h)
#   health        — Health check user (minimal privilege)
#password_file /mosquitto/config/passwd

# Disable anonymous access — all connections must authenticate
allow_anonymous true

# ─── ACLs (Access Control) ───────────────────────────────────────────────────
# acl_file /mosquitto/config/acl.conf
# (See docker/mosquitto/acl.conf for topic-level access control)
# Uncomment and configure for production security hardening.

# ─── Message size ────────────────────────────────────────────────────────────
# Sensor JSON payloads are ~400 bytes; allow generous buffer
message_size_limit 65536

# ─── Connection settings ─────────────────────────────────────────────────────
# keepalive_interval is bridge-only; client keep-alive is set by the client (60s default)

# Maximum in-flight QoS 1 messages
max_inflight_messages 20

# ─── Retained messages ────────────────────────────────────────────────────────
# Device status topics use retain=true — allow this
retain_available true

# ─── Queue settings ──────────────────────────────────────────────────────────
max_queued_messages 1000
queue_qos0_messages false    # QoS 0 not queued — only QoS 1+ is reliable

# ─── TLS (production — uncomment and provide certs) ──────────────────────────
# listener 8883
# protocol mqtt
# cafile   /mosquitto/config/certs/ca.crt
# certfile /mosquitto/config/certs/server.crt
# keyfile  /mosquitto/config/certs/server.key
# require_certificate false
