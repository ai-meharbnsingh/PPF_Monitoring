###############################################################################
# mediamtx.yml
# MediaMTX Configuration — PPF Workshop Monitoring System
#
# Handles RTSP streams from Hikvision IP cameras.
# Exposes streams as:
#   RTSP:   rtsp://<server>:8554/<path>
#   HLS:    http://<server>:8888/<path>
#   WebRTC: http://<server>:8889/<path>
#
# Stream path naming convention (must match backend streams.py):
#   workshop_{workshop_id}_pit_{pit_number}
#   Example: workshop_1_pit_1
#
# Author: PPF Monitoring Team
# Created: 2026-02-22
###############################################################################

# ─── Logging ──────────────────────────────────────────────────────────────────
logLevel: info
logDestinations: [stdout]

# ─── API (used by backend to list/manage paths) ───────────────────────────────
api: yes
apiAddress: :9997
# Optionally enable API authentication in production:
# apiEncryption: no
# apiUsername:
# apiPassword:

# ─── RTSP server ──────────────────────────────────────────────────────────────
rtsp: yes
rtspAddress: :8554
protocols: [tcp]           # tcp is more reliable behind NAT

# ─── HLS server ───────────────────────────────────────────────────────────────
hls: yes
hlsAddress: :8888
hlsAlwaysRemux: yes        # Keep HLS ready even when no viewer is watching
hlsSegmentDuration: 1s
hlsPartDuration: 200ms
hlsSegmentMaxSize: 50M

# ─── WebRTC server ────────────────────────────────────────────────────────────
webrtc: yes
webrtcAddress: :8889

# ─── SRT server (disabled — not needed) ──────────────────────────────────────
srt: no

# ─── RTMP server (disabled — not needed) ─────────────────────────────────────
rtmp: no

# ─────────────────────────────────────────────────────────────────────────────
# Path definitions
#
# Each PPF pit maps to one stream path.
# The Hikvision camera RTSP URL is pulled in from the source.
# Adjust camera URLs as needed.
#
# Hikvision RTSP URL format:
#   rtsp://<user>:<password>@<camera_ip>:<port>/Streaming/Channels/<channel>
#   Main stream: channel 101
#   Sub stream:  channel 102 (lower resolution, better for WebRTC)
# ─────────────────────────────────────────────────────────────────────────────
paths:

  # ── Default path — allows any new path to be created on-the-fly ───────────
  # This allows the backend to push streams dynamically without pre-configuring
  # every pit here.
  ~^.*$:
    source: publisher

  # ── Static example: Workshop 1, Pit 1 ─────────────────────────────────────
  # Uncomment and configure when camera is connected.
  # Replace camera IP and credentials.
  #
  # ── Hikvision DS-2CD — PPF Workshop Pit 1 ─────────────────────────────────
  # Camera IP: 192.168.29.64 | Credentials: admin / Hik@12345
  # Sub-stream (102) used for WebRTC — lower latency than main stream (101)
  # Docker containers on Windows Desktop use host.docker.internal to reach LAN
  # host.docker.internal resolves to the Windows host, which can reach 192.168.29.64
  workshop_1_pit_1:
    source: rtsp://admin:Hik@12345@192.168.29.64:554/Streaming/Channels/102
    sourceOnDemand: yes
    sourceOnDemandStartTimeout: 10s
    sourceOnDemandCloseAfter: 60s

  # ── PP Monitoring Workshop (ID=15), Main Pit (pit_number=1) ─────────────
  workshop_15_pit_1:
    source: rtsp://admin:Hik@12345@192.168.29.64:554/Streaming/Channels/102
    sourceOnDemand: yes
    sourceOnDemandStartTimeout: 10s
    sourceOnDemandCloseAfter: 60s

  # ── Health check path ─────────────────────────────────────────────────────
  # Can be used by monitoring to verify MediaMTX is alive
  health:
    source: publisher
